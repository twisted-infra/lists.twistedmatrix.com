#!/bin/bash

# This script should be runnable in any environment where the 'docker' command
# line will tell an engine to do things.

set -e;

docker build -t base -f base.Dockerfile .;
docker build -t build -f build.Dockerfile .;

mkdir -p build/wheelhouse;

CACHING_ARGS="$(
    if [ -n "${PIP_INDEX_URL}" ]; then
        echo "-e=PIP_TRUSTED_HOST=10.200.10.1 -e=PIP_INDEX_URL=$(echo $PIP_INDEX_URL | sed s/127.0.0.1/10.200.10.1/g)"; # as per 'docker for mac' networking guide alias
    fi;
)";

echo "$argz";

tar cjf - -X .dockerignore . | \
    docker run --rm -i $CACHING_ARGS build | \
    (cd build/wheelhouse; tar xjf -);

docker build -t infratwisted/lists .;

if [ -n "${DOCKER_PUSH_PASSWORD}" ]; then
    docker login -u "${DOCKER_PUSH_USER}" -p "${DOCKER_PUSH_PASSWORD}";
fi;

docker push infratwisted/lists;

if hyper fip detach lists-container; then
    echo successfully detached;
else
    echo detach failed;
fi;
if hyper rm -f lists-container; then
    echo successfully stopped;
else
    echo stop failed;
fi;
hyper run -e MAILGUN_API_KEY -e NO_RENEW --detach \
      --name lists-container --restart=always \
      -v lists-tls:/certificates \
      -v lists-database:/database \
      -v lists-messages:/legacy-mailman-archive \
      -p 443:8443 \
      --size s3 \
      infratwisted/lists;
hyper fip attach 209.177.93.178 lists-container;
